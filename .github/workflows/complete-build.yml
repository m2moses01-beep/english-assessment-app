name: Complete Windows Build

on:
  workflow_dispatch:
  push:
    branches: [ windows-support ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'
    
    - name: Install Visual Studio 2022
      run: |
        # Install Visual Studio with C++ support
        choco install visualstudio2022community -y --package-parameters '--add Microsoft.VisualStudio.Workload.NativeDesktop --includeRecommended --quiet --norestart --wait'
        choco install windows-sdk-10.0 -y
        choco install cmake -y
        choco install ninja -y
    
    - name: Setup Windows Desktop
      run: |
        # Enable Windows desktop
        flutter config --enable-windows-desktop
        # Create Windows project files
        flutter create --platforms=windows .
        flutter doctor -v
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Build Windows App
      run: |
        echo '=== Building Windows app ==='
        flutter clean
        flutter build windows --release --verbose
        echo '=== Build complete ==='
    
    - name: List build files
      run: |
        echo '=== Checking build output ==='
        if exist build\windows\runner\Release (
            dir build\windows\runner\Release
        ) else (
            echo 'No Release folder found!'
            dir build
            dir build\windows 2>nul || echo 'No windows folder'
            dir build\windows\runner 2>nul || echo 'No runner folder'
        )
    
    - name: Upload Windows App
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Windows-App
        path: build/windows/runner/Release/
        if-no-files-found: error
