name: Flutter Build APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: subosito/flutter-action@v2
    
    - name: Create and fix Android project
      run: |
        echo "=== Creating and fixing Android project ==="
        
        # Remove old android folder
        rm -rf android
        
        # Save our code
        if [ -d "lib" ]; then
          cp -r lib lib_backup
        fi
        
        # Let Flutter create complete project
        flutter create --template app --platforms android --org com.example --project-name english_assessment .
        
        # Restore our code
        if [ -d "lib_backup" ]; then
          rm -rf lib
          mv lib_backup lib
        fi
        
        # CRITICAL: FORCE add flutterEmbedding:2 to AndroidManifest.xml
        echo "=== Adding flutterEmbedding:2 to AndroidManifest.xml ==="
        
        # Read the current AndroidManifest.xml
        MANIFEST_FILE="android/app/src/main/AndroidManifest.xml"
        
        # Check if flutterEmbedding already exists
        if grep -q "flutterEmbedding" "$MANIFEST_FILE"; then
          echo "flutterEmbedding already exists, updating to value='2'"
          # Update existing to value="2"
          sed -i 's/android:name="flutterEmbedding".*/android:name="flutterEmbedding" android:value="2"\/>/' "$MANIFEST_FILE"
        else
          echo "Adding flutterEmbedding meta-data"
          # Add flutterEmbedding after <application> tag
          sed -i '/<application/a\        <meta-data android:name="flutterEmbedding" android:value="2"\/>' "$MANIFEST_FILE"
        fi
        
        # Verify the change
        echo "=== Updated AndroidManifest.xml ==="
        grep -n "flutterEmbedding" "$MANIFEST_FILE" || echo "ERROR: flutterEmbedding not found!"
        
        echo "âœ… Android project created and fixed"
    
    - name: Build APK
      run: |
        flutter pub get
        flutter build apk --release
    
    - uses: actions/upload-artifact@v4
      with:
        name: english-assessment-app
        path: build/app/outputs/flutter-apk/app-release.apk
