name: Build Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Fix Windows Files
      run: |
        echo "=== Fixing Windows Build Files ==="
        
        # 1. Create resource.h if missing or fix it
        echo "#pragma once" > windows/runner/resource.h
        echo. >> windows/runner/resource.h
        echo "#define IDI_APP_ICON 101" >> windows/runner/resource.h
        echo "#define IDR_APPLICATION_MANIFEST 102" >> windows/runner/resource.h
        
        # 2. Create runner.rc if missing
        if not exist windows/runner/runner.rc (
          echo #include "resource.h" > windows/runner/runner.rc
          echo. >> windows/runner/runner.rc
          echo IDI_APP_ICON ICON "resources/app_icon.ico" >> windows/runner/runner.rc
          echo. >> windows/runner/runner.rc
          echo IDR_APPLICATION_MANIFEST RT_MANIFEST "runner.exe.manifest" >> windows/runner/runner.rc
        )
        
        # 3. Create resources directory and placeholder icon
        if not exist windows/runner/resources mkdir windows/runner/resources
        if not exist windows/runner/resources/app_icon.ico (
          # Minimal ICO file (1x1 transparent pixel)
          echo 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01, 0x00, 0x08, 0x00, 0x28, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00 | Out-File -Encoding byte windows/runner/resources/app_icon.ico
        )
        
        echo "âœ… Windows files fixed"
    
    - name: Install Dependencies
      run: flutter pub get
    
    - name: Build Windows
      run: flutter build windows --release
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/windows/runner/Release/
