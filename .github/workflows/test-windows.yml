name: Build Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Fix Windows Files
      run: |
        Write-Host "=== Fixing Windows Build Files ===" -ForegroundColor Green
        
        # 1. Create resource.h if missing or fix it
        $resourceContent = @'
#pragma once

#define IDI_APP_ICON                    101
#define IDR_APPLICATION_MANIFEST        102
'@
        Set-Content -Path "windows/runner/resource.h" -Value $resourceContent -Encoding ASCII
        Write-Host "✅ Fixed resource.h" -ForegroundColor Green
        
        # 2. Create runner.rc if missing
        if (!(Test-Path "windows/runner/runner.rc")) {
          $runnerRcContent = @'
#include "resource.h"

IDI_APP_ICON ICON "resources/app_icon.ico"

IDR_APPLICATION_MANIFEST RT_MANIFEST "runner.exe.manifest"
'@
          Set-Content -Path "windows/runner/runner.rc" -Value $runnerRcContent -Encoding ASCII
          Write-Host "✅ Created runner.rc" -ForegroundColor Green
        }
        
        # 3. Create resources directory and placeholder icon
        if (!(Test-Path "windows/runner/resources")) {
          New-Item -ItemType Directory -Path "windows/runner/resources" -Force | Out-Null
          Write-Host "✅ Created resources directory" -ForegroundColor Green
        }
        
        if (!(Test-Path "windows/runner/resources/app_icon.ico")) {
          # Minimal ICO file (1x1 transparent pixel)
          $iconBytes = @(
            0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x01, 
            0x00, 0x00, 0x01, 0x00, 0x08, 0x00, 0x28, 0x00, 
            0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x28, 0x00, 
            0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 
            0x00, 0x00, 0x01, 0x00, 0x08, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 
            0xFF, 0x00, 0x00, 0x00, 0x00, 0x00
          )
          [System.IO.File]::WriteAllBytes("windows/runner/resources/app_icon.ico", $iconBytes)
          Write-Host "✅ Created app_icon.ico" -ForegroundColor Green
        }
        
        Write-Host "=== Verification ===" -ForegroundColor Cyan
        Write-Host "resource.h exists: $(Test-Path 'windows/runner/resource.h')"
        Write-Host "runner.rc exists: $(Test-Path 'windows/runner/runner.rc')"
        Write-Host "app_icon.ico exists: $(Test-Path 'windows/runner/resources/app_icon.ico')"
    
    - name: Install Dependencies
      run: flutter pub get
    
    - name: Build Windows
      run: flutter build windows --release
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/windows/runner/Release/
